# AI 배차 시스템 - 전체 프로세스 가이드

## 📋 현재 시스템 개요

### 시스템 구성
```
1. 거래처 관리 → 2. 차량 관리 → 3. 주문 등록 → 4. AI 배차 최적화 → 5. 배차 확정 → 6. 실시간 모니터링
```

---

## 🔄 전체 워크플로우

### **1단계: 기본 데이터 준비** ✅
```
거래처 관리
├── 거래처 등록 (상차/하차 업체)
│   ├── 주소 및 좌표 정보
│   ├── 상차/하차 가능 시간
│   ├── 지게차 유무
│   └── 상하차 소요시간
│
차량 관리
├── 차량 등록
│   ├── 차량 타입 (냉동/냉장/겸용/상온)
│   ├── 적재 용량 (팔레트/중량)
│   ├── 지게차 가능 여부
│   ├── 차고지 위치
│   └── UVIS GPS 연동 (선택)
```

### **2단계: 주문 등록** 📝
```
주문 관리
├── 주문 등록 방법
│   ├── 개별 등록 (UI)
│   └── 엑셀 일괄 등록
│
├── 주문 정보
│   ├── 온도대 (냉동/냉장/상온)
│   ├── 상차 거래처
│   ├── 하차 거래처
│   ├── 팔레트 수량
│   ├── 용적 (CBM)
│   ├── 시간 제약 (픽업/배송 시간)
│   ├── 우선순위
│   ├── 지게차 필요 여부
│   └── 적재 가능 여부
│
└── 주문 상태
    └── 배차대기 (자동 설정)
```

### **3단계: AI 배차 최적화** 🤖
```
배차 최적화
├── 주문 선택
│   ├── 배차대기 상태 주문 조회
│   └── 배차할 주문 선택 (다중 선택 가능)
│
├── 알고리즘 선택
│   ├── Option 1: Greedy (빠른 배차)
│   │   ├── 거리 기반 최적화
│   │   ├── 온도대 매칭
│   │   └── 적재 용량 제약
│   │
│   └── Option 2: CVRPTW (고급 최적화) ⭐ 권장
│       ├── Google OR-Tools 사용
│       ├── 시간 제약 (Time Windows)
│       ├── 용량 제약 (Capacity)
│       ├── 온도대 매칭
│       ├── 거리 최소화
│       └── 균등 배분
│
├── 최적화 설정
│   ├── 시간 제한 (5-300초, 기본 30초)
│   ├── 시간 제약 사용 여부
│   └── 실제 경로 사용 (Naver API)
│
└── 최적화 실행
    ├── AI가 자동으로 차량 할당
    ├── 최적 경로 계산
    ├── 시간 예측
    └── 임시 배차 생성
```

### **4단계: 배차 확정** ✅
```
배차 검토
├── 생성된 배차 계획 확인
│   ├── 차량별 배정 주문
│   ├── 경로 순서
│   ├── 예상 시간/거리
│   └── 적재율
│
├── 수정 (필요시)
│   ├── 차량 변경
│   ├── 경로 순서 조정
│   └── 주문 재배정
│
└── 배차 확정
    ├── 상태: 임시저장 → 확정
    ├── 주문 상태: 배차대기 → 배차완료
    └── 알림 발송 (선택)
```

### **5단계: 실시간 모니터링** 📍
```
실시간 대시보드
├── GPS 위치 추적 (UVIS 연동)
│   ├── 차량 위치 표시
│   ├── 시동 ON/OFF
│   ├── 속도
│   └── 온도 (A/B)
│
├── 배송 진행 상태
│   ├── 출발
│   ├── 상차 완료
│   ├── 배송 중
│   └── 배송 완료
│
└── 알림
    ├── 지연 알림
    ├── 온도 이상 알림
    └── 완료 알림
```

---

## 🎯 현재 페이지별 기능

### 1️⃣ **주문 관리** (`/orders`)
- ✅ 주문 등록 (개별/엑셀)
- ✅ 주문 조회/수정/삭제
- ✅ 상태별 필터링 (배차대기/배차완료/운송중/배송완료)
- ✅ 거래처 연동

### 2️⃣ **배차 최적화** (`/optimization`)
- ✅ 배차대기 주문 목록
- ✅ 주문 선택
- ✅ AI 최적화 실행 (Greedy / CVRPTW)
- ✅ 최적화 설정 (시간 제한, 시간 제약, 실제 경로)
- ✅ 결과 미리보기
- ✅ 배차 확정

### 3️⃣ **배차 관리** (`/dispatches`)
- ✅ 배차 목록 조회
- ✅ 상태별 필터링 (임시저장/확정/진행중/완료)
- ✅ 실시간 차량 위치 (지도)
- ✅ 배차 수정/삭제

### 4️⃣ **실시간 대시보드** (`/realtime`)
- ✅ GPS 실시간 추적
- ✅ 차량 시동 상태
- ✅ 온도 모니터링
- ✅ 속도 표시
- ✅ 차량 찾기

---

## 💡 AI 배차 알고리즘 상세

### **알고리즘 1: Greedy (기본)**
```python
# 장점:
✅ 빠른 실행 (1-2초)
✅ 간단한 로직
✅ 소규모 배차에 적합

# 제약사항:
- 온도대 매칭
- 적재 용량 (팔레트/중량)
- 거리 최소화

# 사용 시나리오:
- 주문 10건 이하
- 빠른 배차 필요
- 간단한 경로
```

### **알고리즘 2: CVRPTW (고급)** ⭐
```python
# 장점:
✅ 고급 최적화 (Google OR-Tools)
✅ 시간 제약 고려
✅ 여러 제약 동시 처리
✅ 최적해 보장 (제한 시간 내)

# 제약사항:
- 온도대 매칭
- 적재 용량 (팔레트/중량/용적)
- 시간 제약 (픽업/배송 시간)
- 거리 최소화
- 균등 배분 (차량 간 작업 부하 균형)
- 지게차 요구사항

# 사용 시나리오:
- 주문 10건 이상
- 복잡한 시간 제약
- 최적화가 중요한 경우
```

---

## 🚀 사용 방법 (단계별 가이드)

### **Step 1: 거래처 등록**
```
1. http://139.150.11.99/clients
2. [+ 거래처 등록] 클릭
3. 필수 정보 입력:
   - 거래처명, 주소, 구분(상차/하차/양쪽)
   - 상차/하차 가능 시간
   - 지게차 유무
4. [등록] 클릭
```

### **Step 2: 차량 등록**
```
1. http://139.150.11.99/vehicles
2. [+ 차량 등록] 클릭
3. 필수 정보 입력:
   - 차량번호, 차량타입(냉동/냉장/겸용/상온)
   - 최대 팔레트, 톤수
   - 지게차 가능 여부
   - 차고지 주소
4. [등록] 클릭
```

### **Step 3: 주문 등록**
```
방법 A: 개별 등록
1. http://139.150.11.99/orders
2. [+ 주문 등록] 클릭
3. 정보 입력:
   - 온도대 선택
   - 상차/하차 거래처
   - 팔레트 수량
   - 시간 제약
4. [등록] 클릭

방법 B: 엑셀 일괄 등록
1. [양식 다운로드] 클릭
2. orders_template.xlsx 작성
3. [엑셀 업로드] 클릭
```

### **Step 4: AI 배차 최적화** ⭐
```
1. http://139.150.11.99/optimization
2. 배차대기 주문 확인
3. 배차할 주문 선택 (체크박스)
4. 알고리즘 선택:
   - Greedy (빠름)
   - CVRPTW (정확) ← 권장
5. 설정 (CVRPTW):
   - 시간 제한: 30초 (기본)
   - 시간 제약 사용: ON (권장)
   - 실제 경로: OFF (빠름) / ON (정확)
6. [AI 배차 최적화] 클릭
7. 결과 확인:
   - 차량별 배정
   - 경로 순서
   - 예상 시간/거리
8. [배차 확정] 클릭
```

### **Step 5: 실시간 모니터링**
```
1. http://139.150.11.99/realtime
2. GPS 위치 확인
3. 시동 상태 확인
4. 온도 모니터링
5. 차량 찾기 (드롭다운)
```

---

## 📊 AI 배차 예시

### **시나리오: 10개 주문 배차**
```
입력:
- 주문 10건 (냉동 5건, 냉장 5건)
- 차량 3대 (냉동 1대, 냉장 1대, 겸용 1대)

AI 최적화 결과:
┌────────┬──────────┬──────┬─────────┬──────────┐
│ 차량   │ 배정주문 │ 거리 │ 예상시간│ 적재율   │
├────────┼──────────┼──────┼─────────┼──────────┤
│ 냉동차 │ 4건      │ 85km │ 3.5시간 │ 80%      │
│ 냉장차 │ 4건      │ 92km │ 4.0시간 │ 85%      │
│ 겸용차 │ 2건      │ 45km │ 2.0시간 │ 40%      │
└────────┴──────────┴──────┴─────────┴──────────┘

최적화 목표:
✅ 총 거리 최소화: 222km
✅ 시간 제약 만족: 모든 배송 시간 내
✅ 온도대 매칭: 100%
✅ 용량 제약 준수: 100%
```

---

## 🔧 최적화 팁

### ✅ **배차 효율을 높이려면**
1. **거래처 정보 정확히 입력**
   - 주소와 좌표 정확성
   - 시간 제약 현실적으로 설정

2. **차량 정보 최신 유지**
   - 차고지 위치 정확히
   - 적재 용량 실제 값 입력

3. **주문 정보 상세히 작성**
   - 온도대 정확히
   - 팔레트 수량 정확히
   - 지게차 필요 여부 명시

4. **최적화 설정 조정**
   - 복잡한 배차: 시간 제한 60초 이상
   - 시간 제약 중요: use_time_windows=True
   - 정확한 거리: use_real_routing=True (느림)

### ⚠️ **주의사항**
- Greedy: 빠르지만 최적해 아닐 수 있음
- CVRPTW: 시간이 오래 걸릴 수 있음 (30-60초)
- Real Routing: Naver API 호출로 느림 (10초 이상)
- 주문 많을수록: 시간 제한 늘려야 함

---

## 🎯 현재 시스템 강점

✅ **자동화**: 주문 등록 → AI가 자동 배차
✅ **최적화**: 거리/시간/용량 동시 최적화
✅ **실시간**: GPS 연동 실시간 추적
✅ **유연성**: 2가지 알고리즘 선택 가능
✅ **확장성**: 다양한 제약 조건 지원

---

## 📈 개선 가능 영역

### 1️⃣ **자동 배차 트리거**
현재: 수동으로 최적화 버튼 클릭
개선: 주문 등록 시 자동 배차 옵션

### 2️⃣ **배차 템플릿**
현재: 매번 수동 설정
개선: 저장된 설정 템플릿

### 3️⃣ **배차 이력 분석**
현재: 배차만 실행
개선: 과거 배차 데이터 분석 및 개선 제안

### 4️⃣ **알림 시스템**
현재: 수동 확인
개선: 배차 완료/이상 알림 자동 발송

---

## 📞 API 엔드포인트

### **배차 최적화 API**
```bash
# Greedy 알고리즘
POST /api/v1/dispatches/optimize
{
  "order_ids": [1, 2, 3],
  "vehicle_ids": [1, 2],
  "dispatch_date": "2026-01-29"
}

# CVRPTW 알고리즘 (권장)
POST /api/v1/dispatches/optimize-cvrptw?time_limit=30&use_time_windows=true&use_real_routing=false
{
  "order_ids": [1, 2, 3, 4, 5],
  "vehicle_ids": [1, 2, 3],
  "dispatch_date": "2026-01-29"
}
```

### **배차 확정 API**
```bash
POST /api/v1/dispatches/confirm
{
  "dispatch_ids": [1, 2, 3]
}
```

---

## 🎓 학습 리소스

- **OR-Tools 공식 문서**: https://developers.google.com/optimization
- **CVRPTW 설명**: https://en.wikipedia.org/wiki/Vehicle_routing_problem
- **배차 최적화 알고리즘**: 코드 참조 (`dispatch_optimization_service.py`)

---

## 📝 요약

현재 시스템은 **완전한 AI 배차 시스템**입니다:

1. ✅ 거래처/차량 등록
2. ✅ 주문 등록 (개별/엑셀)
3. ✅ AI 자동 배차 (2가지 알고리즘)
4. ✅ 배차 확정
5. ✅ 실시간 GPS 추적

**사용 흐름**: 주문 등록 → 배차 최적화 페이지 → 주문 선택 → AI 최적화 실행 → 결과 확인 → 배차 확정 → 실시간 모니터링

**핵심**: `/optimization` 페이지에서 AI 배차 실행!
