input {
  tcp {
    port => 5000
    codec => json
    tags => ["tcp"]
  }

  beats {
    port => 5044
    tags => ["beats"]
  }

  http {
    port => 8080
    codec => json
    tags => ["http"]
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      target => "parsed"
    }
  }

  # Add timestamp
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }

  # Extract log level
  if [parsed][level] {
    mutate {
      add_field => { "log_level" => "%{[parsed][level]}" }
    }
  }

  # Extract service name from container
  if [container][name] {
    mutate {
      add_field => { "service" => "%{[container][name]}" }
    }
  }

  # Geo IP enrichment for IP addresses
  if [parsed][client_ip] {
    geoip {
      source => "[parsed][client_ip]"
      target => "geoip"
    }
  }

  # User agent parsing
  if [parsed][user_agent] {
    useragent {
      source => "[parsed][user_agent]"
      target => "user_agent"
    }
  }

  # Tag error logs
  if [log_level] =~ /(?i)(error|fatal|critical)/ {
    mutate {
      add_tag => ["error"]
    }
  }

  # Tag slow queries (> 1000ms)
  if [parsed][duration_ms] and [parsed][duration_ms] > 1000 {
    mutate {
      add_tag => ["slow_query"]
    }
  }

  # Remove unnecessary fields
  mutate {
    remove_field => ["agent", "ecs", "host"]
  }
}

output {
  # Main logs index
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    index => "uvis-logs-%{+YYYY.MM.dd}"
    manage_template => true
    template_name => "uvis-logs"
    template_overwrite => true
  }

  # Error logs to separate index
  if "error" in [tags] {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      index => "uvis-errors-%{+YYYY.MM.dd}"
    }
  }

  # Slow queries to separate index
  if "slow_query" in [tags] {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      index => "uvis-slow-queries-%{+YYYY.MM.dd}"
    }
  }

  # Debug output (comment out in production)
  # stdout { codec => rubydebug }
}
