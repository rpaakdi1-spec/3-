metricbeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: false

# Docker module
metricbeat.modules:
  - module: docker
    metricsets:
      - "container"
      - "cpu"
      - "diskio"
      - "healthcheck"
      - "info"
      - "memory"
      - "network"
    hosts: ["unix:///var/run/docker.sock"]
    period: 10s
    enabled: true

  - module: system
    metricsets:
      - cpu
      - load
      - memory
      - network
      - process
      - process_summary
      - socket_summary
      - filesystem
      - fsstat
    enabled: true
    period: 10s
    processes: ['.*']
    cpu.metrics: ["percentages", "normalized_percentages"]
    core.metrics: ["percentages"]

  - module: postgresql
    enabled: false
    metricsets:
      - database
      - bgwriter
      - activity
    period: 10s
    hosts: ["postgres://postgres:5432?sslmode=disable"]
    username: postgres
    password: password

  - module: redis
    enabled: false
    metricsets: ["info", "keyspace"]
    period: 10s
    hosts: ["redis:6379"]

# Processors
processors:
  - add_cloud_metadata: ~
  - add_docker_metadata: ~
  - add_host_metadata:
      netinfo.enabled: true

# Output to Elasticsearch
output.elasticsearch:
  hosts: ["${ELASTICSEARCH_HOST}"]
  username: "elastic"
  password: "${ELASTIC_PASSWORD}"
  indices:
    - index: "metricbeat-docker-%{+yyyy.MM.dd}"
      when.equals:
        metricset.module: "docker"
    - index: "metricbeat-system-%{+yyyy.MM.dd}"
      when.equals:
        metricset.module: "system"

# Kibana endpoint
setup.kibana:
  host: "${KIBANA_HOST}"
  username: "elastic"
  password: "${ELASTIC_PASSWORD}"

# Dashboards
setup.dashboards.enabled: true
setup.dashboards.retry.enabled: true

# Index lifecycle management
setup.ilm.enabled: true
setup.ilm.rollover_alias: "metricbeat"
setup.ilm.pattern: "{now/d}-000001"

# Logging
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/metricbeat
  name: metricbeat
  keepfiles: 7
  permissions: 0644
