# 🚨 긴급정비(고장) 대응 방안

> **목적**: 운행 중/후 차량 고장 발생 시 신속한 대응 및 배차 재조정을 통한 서비스 연속성 보장

## 📋 목차

1. [개요](#개요)
2. [긴급정비 프로세스](#긴급정비-프로세스)
3. [시스템 구현 사항](#시스템-구현-사항)
4. [사용자 시나리오](#사용자-시나리오)
5. [API 명세](#api-명세)

---

## 개요

### 🎯 목표
- 고장 발생 즉시 감지 및 알림
- 배차 영향도 자동 분석
- 대체 차량 자동 추천
- 배차 재조정 자동화
- 고객사 사전 통보

### 📊 긴급정비 분류

#### 1. **긴급도 레벨**
- 🔴 **긴급 (Critical)**: 즉시 운행 불가, 대체 차량 필수
  - 엔진 고장, 타이어 펑크, 냉동기 완전 고장 등
- 🟡 **주의 (Warning)**: 운행 가능하나 조속한 정비 필요
  - 냉동기 온도 이상, 경미한 엔진 오류 등
- 🟢 **경미 (Minor)**: 운행 가능, 운행 후 정비
  - 램프 고장, 경미한 외관 손상 등

#### 2. **발생 시점**
- **운행 전**: 출발 전 점검 중 발견
- **운행 중**: 배송 진행 중 발생
- **운행 후**: 귀고 후 발견

---

## 긴급정비 프로세스

### 🔄 전체 프로세스 흐름

```
┌─────────────────┐
│  1. 고장 감지   │
│  (자동/수동)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  2. 긴급도 판정 │
│  (시스템 자동)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  3. 알림 발송   │
│  (관리자/운전자)│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  4. 영향도 분석 │
│  (배차 영향)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  5. 대체 차량   │
│     자동 추천   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  6. 배차 재조정 │
│  (수동/자동)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  7. 고객사 통보 │
│  (SMS/알림톡)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  8. 정비 완료   │
│    및 복귀      │
└─────────────────┘
```

---

## 시스템 구현 사항

### 1. 차량 상태 관리 강화

#### 📌 차량 상태 (Vehicle Status)

기존:
```python
class VehicleStatus(str, Enum):
    AVAILABLE = "운행가능"      # 운행 가능
    IN_USE = "운행중"           # 운행 중
    MAINTENANCE = "정비중"      # 계획된 정비
    UNAVAILABLE = "운행불가"    # 영구 불가
```

추가:
```python
class VehicleStatus(str, Enum):
    AVAILABLE = "운행가능"              # 운행 가능
    IN_USE = "운행중"                   # 운행 중
    MAINTENANCE = "정비중"              # 계획된 정비
    EMERGENCY_MAINTENANCE = "긴급정비"  # 🆕 긴급 정비 중
    BREAKDOWN = "고장"                  # 🆕 고장 (운행 불가)
    UNAVAILABLE = "운행불가"            # 영구 불가
```

#### 📌 긴급정비 플래그 추가

```python
# Vehicle Model 추가 필드
class Vehicle(Base):
    # ... 기존 필드 ...
    
    # 긴급정비 관련
    is_emergency: bool = False                    # 긴급 상황 여부
    emergency_type: str = None                    # 긴급 유형 (breakdown, malfunction, accident)
    emergency_severity: str = None                # 긴급도 (critical, warning, minor)
    emergency_reported_at: datetime = None        # 신고 시각
    emergency_location: str = None                # 발생 위치
    emergency_description: str = None             # 상황 설명
    estimated_repair_time: int = None             # 예상 수리 시간(분)
    replacement_vehicle_id: int = None            # 대체 차량 ID
```

---

### 2. 긴급정비 알림 시스템

#### 📌 알림 대상
1. **운영 관리자** (즉시)
   - SMS + 시스템 알림
   - 배차 영향도 포함
2. **배차 담당자** (즉시)
   - 영향받는 배차 목록
   - 대체 차량 추천 리스트
3. **해당 운전자** (확인)
   - 조치 사항 안내
4. **고객사** (상황에 따라)
   - 배송 지연 예상 시

#### 📌 알림 내용

```
🚨 긴급정비 발생

차량: 12가3456 (V001)
운전자: 홍길동 (010-1234-5678)
발생시각: 2026-01-30 14:30
위치: 서울시 강남구 테헤란로 123
상황: 냉동기 고장 (온도 유지 불가)
긴급도: 🔴 긴급

영향받는 배차:
- D2026-001: 삼성전자 → 하이마트 (15:00 픽업 예정)
- D2026-003: LG전자 → 이마트 (16:30 픽업 예정)

대체 차량 추천:
1. 34나5678 (V005) - 냉동 차량, 현위치 5km
2. 56다7890 (V008) - 냉동 차량, 현위치 8km

[대체 차량 배정하기] [배차 취소하기]
```

---

### 3. 대체 차량 자동 추천

#### 📌 추천 알고리즘

```python
def recommend_replacement_vehicles(broken_vehicle, affected_dispatches):
    """
    대체 차량 자동 추천
    
    고려 사항:
    1. 온도대 일치 (필수)
    2. 적재 용량 충족
    3. 현재 위치 근접성
    4. 운전자 가용성
    5. 지게차 운전 능력 (필요시)
    """
    
    criteria = {
        'temperature_zone': broken_vehicle.temperature_zone,
        'min_capacity': max(dispatch.total_weight for dispatch in affected_dispatches),
        'status': VehicleStatus.AVAILABLE,
        'is_active': True
    }
    
    candidates = Vehicle.query.filter_by(**criteria).all()
    
    # 거리 기준 정렬
    sorted_candidates = sorted(
        candidates,
        key=lambda v: calculate_distance(
            v.current_location, 
            broken_vehicle.current_location
        )
    )
    
    return sorted_candidates[:5]  # 상위 5개 추천
```

#### 📌 추천 우선순위

1. **온도대 일치** (필수)
   - 냉동 차량 고장 → 냉동 차량만 추천
2. **적재 용량**
   - 영향받는 모든 배차를 커버 가능한 용량
3. **현재 위치**
   - 고장 차량 위치와 가까울수록 우선
4. **운전자 스킬**
   - 지게차 운전 필요 시 해당 능력 보유 차량
5. **예약 상태**
   - 당일 예약이 없는 차량 우선

---

### 4. 배차 재조정 기능

#### 📌 재조정 옵션

##### 옵션 1: 대체 차량으로 전체 이관
```
원래 배차: 12가3456 (고장)
  ├─ D2026-001: 삼성 → 하이마트
  ├─ D2026-002: LG → 이마트
  └─ D2026-003: 현대 → 롯데

↓ 재조정

대체 차량: 34나5678
  ├─ D2026-001: 삼성 → 하이마트 ✅
  ├─ D2026-002: LG → 이마트 ✅
  └─ D2026-003: 현대 → 롯데 ✅
```

##### 옵션 2: 복수 차량으로 분산
```
원래 배차: 12가3456 (고장)
  ├─ D2026-001: 삼성 → 하이마트 (3톤)
  ├─ D2026-002: LG → 이마트 (2톤)
  └─ D2026-003: 현대 → 롯데 (2톤)

↓ 재조정 (용량 부족으로 분산)

대체 차량 1: 34나5678 (5톤)
  ├─ D2026-001: 삼성 → 하이마트 ✅
  └─ D2026-002: LG → 이마트 ✅

대체 차량 2: 56다7890 (3톤)
  └─ D2026-003: 현대 → 롯데 ✅
```

##### 옵션 3: 일부 배차 취소/연기
```
원래 배차: 12가3456 (고장)
  ├─ D2026-001: 삼성 → 하이마트 (긴급)
  ├─ D2026-002: LG → 이마트 (일반)
  └─ D2026-003: 현대 → 롯데 (일반)

↓ 재조정

대체 차량: 34나5678
  └─ D2026-001: 삼성 → 하이마트 ✅ (긴급 건만)

취소/연기:
  ├─ D2026-002: 고객사 협의 후 내일로 연기
  └─ D2026-003: 고객사 협의 후 내일로 연기
```

#### 📌 재조정 워크플로우

```python
class DispatchReassignment:
    """배차 재조정 서비스"""
    
    def reassign_dispatches(
        self,
        broken_vehicle_id: int,
        replacement_vehicle_ids: List[int],
        strategy: str = 'auto'  # auto, manual, cancel
    ):
        """
        배차 재조정 실행
        
        Args:
            broken_vehicle_id: 고장 차량 ID
            replacement_vehicle_ids: 대체 차량 ID 목록
            strategy: 재조정 전략 (auto/manual/cancel)
        """
        # 1. 영향받는 배차 조회
        affected_dispatches = self._get_affected_dispatches(broken_vehicle_id)
        
        # 2. 대체 차량 용량 확인
        replacement_vehicles = Vehicle.query.filter(
            Vehicle.id.in_(replacement_vehicle_ids)
        ).all()
        
        # 3. 재조정 계획 수립
        plan = self._create_reassignment_plan(
            affected_dispatches,
            replacement_vehicles,
            strategy
        )
        
        # 4. 재조정 실행
        result = self._execute_reassignment(plan)
        
        # 5. 고객사 통보
        self._notify_customers(result)
        
        return result
```

---

### 5. 고객사 통보 시스템

#### 📌 통보 대상 배차

```python
def should_notify_customer(dispatch, delay_minutes):
    """고객사 통보 필요 여부 판단"""
    
    # 1. 긴급 배차는 무조건 통보
    if dispatch.priority == 'urgent':
        return True
    
    # 2. 30분 이상 지연 예상 시 통보
    if delay_minutes >= 30:
        return True
    
    # 3. 냉동/냉장 화물은 20분 이상 지연 시 통보
    if dispatch.temperature_zone in ['냉동', '냉장'] and delay_minutes >= 20:
        return True
    
    return False
```

#### 📌 통보 메시지

**SMS 예시:**
```
[UVIS 긴급알림]
고객사: 삼성전자
배차번호: D2026-001
차량 긴급정비로 인해 픽업 시간이 약 30분 지연될 예정입니다.
예정: 15:00 → 변경: 15:30
대체 차량으로 안전하게 배송하겠습니다.
문의: 02-1234-5678
```

**알림톡 예시:**
```
🚨 배송 일정 변경 안내

고객사: 삼성전자
배차번호: D2026-001
출발지: 서울시 강남구 테헤란로 123
목적지: 하이마트 강남점

변경 사유: 차량 긴급정비
기존 픽업 시간: 15:00
변경 픽업 시간: 15:30 (약 30분 지연)

대체 차량: 34나5678 (냉동 차량)
운전자: 김철수 (010-9876-5432)

안전하게 배송하겠습니다.
문의사항은 고객센터로 연락 주세요.
☎ 02-1234-5678
```

---

## 사용자 시나리오

### 시나리오 1: 운행 중 냉동기 고장

**상황:**
- 차량: 12가3456 (냉동 차량)
- 운전자: 홍길동
- 시각: 14:30
- 위치: 서울시 강남구 (배송 중)
- 고장: 냉동기 완전 고장 (온도 유지 불가)

**프로세스:**

1. **고장 감지** (자동)
   ```
   - UVIS GPS: 냉동기 온도 급상승 감지 (-18°C → 5°C)
   - 시스템: 자동으로 긴급 알림 발생
   ```

2. **운전자 신고** (수동)
   ```
   모바일 앱 > 긴급신고 버튼
   - 상황: 냉동기 고장
   - 설명: 냉동기 완전 정지, 온도 상승 중
   - 위치: GPS 자동 기록
   ```

3. **시스템 자동 처리**
   ```
   ✅ 차량 상태: 운행중 → 고장
   ✅ 긴급도: 🔴 긴급 (Critical)
   ✅ 관리자/배차담당 SMS 발송
   ✅ 영향받는 배차 분석:
      - D2026-001: 15:00 픽업 예정 (30분 남음)
      - D2026-003: 16:30 픽업 예정 (2시간 남음)
   ✅ 대체 차량 자동 추천:
      1. 34나5678 (5km 거리, 냉동, 가용)
      2. 56다7890 (8km 거리, 냉동, 가용)
   ```

4. **배차 담당자 조치**
   ```
   대시보드 > 긴급알림 확인
   
   [대체 차량 배정]
   - 선택: 34나5678 (김철수)
   - 배차 이관: D2026-001, D2026-003 → 34나5678로 변경
   - 운전자 통보: 김철수에게 SMS 발송
   ```

5. **고객사 통보**
   ```
   시스템 자동 SMS 발송:
   - 대상: 삼성전자, 현대자동차
   - 내용: 차량 교체, 픽업 시간 약간 지연 예상
   ```

6. **정비 처리**
   ```
   관리자 > 차량관리 > 12가3456
   - 상태: 고장 → 긴급정비
   - 정비소: ABC정비소
   - 예상 완료: 내일 오전 10시
   ```

---

### 시나리오 2: 운행 전 타이어 펑크

**상황:**
- 차량: 78라9012 (냉장 차량)
- 운전자: 이영희
- 시각: 07:30 (출발 전)
- 위치: 차고지
- 고장: 타이어 펑크

**프로세스:**

1. **운전자 신고**
   ```
   출발 전 점검 중 타이어 펑크 발견
   → 모바일 앱 > 긴급신고
   ```

2. **시스템 자동 처리**
   ```
   ✅ 차량 상태: 운행가능 → 고장
   ✅ 긴급도: 🟡 주의 (타이어 교체 1시간 소요)
   ✅ 영향받는 배차:
      - D2026-010: 09:00 픽업 예정 (1.5시간 남음)
   ✅ 대체 차량 추천:
      1. 23마3456 (차고지 근처, 냉장, 가용)
   ```

3. **배차 담당자 조치**
   ```
   [옵션 A] 타이어 긴급 교체 (1시간)
   - 09:00 픽업은 정상 진행 가능
   - 긴급출동 타이어 서비스 요청
   
   [옵션 B] 대체 차량 배정
   - 23마3456으로 배차 변경
   - 78라9012는 정비소 이동
   
   → 선택: 옵션 A (시간 여유 있음)
   ```

4. **고객사 통보**
   ```
   경미한 지연(10분 이내) 예상
   → 통보 불필요
   ```

---

### 시나리오 3: 운행 후 엔진 경고등

**상황:**
- 차량: 45바6789 (상온 차량)
- 운전자: 박민수
- 시각: 18:00 (배송 완료 후 귀고 중)
- 위치: 귀고 중
- 고장: 엔진 경고등 점등

**프로세스:**

1. **운전자 신고**
   ```
   귀고 중 엔진 경고등 점등
   → 모바일 앱 > 정비 요청
   ```

2. **시스템 자동 처리**
   ```
   ✅ 차량 상태: 운행중 → 주의 (Warning)
   ✅ 긴급도: 🟢 경미 (운행 가능)
   ✅ 영향받는 배차: 없음 (당일 배차 완료)
   ✅ 조치: 내일 정비 예약
   ```

3. **관리자 조치**
   ```
   내일 배차 확인:
   - 45바6789: 내일 배차 없음
   
   정비 예약:
   - 정비소: ABC정비소
   - 일시: 내일 09:00
   - 예상 소요: 2시간
   ```

---

## API 명세

### 1. 긴급정비 신고

```http
POST /api/v1/vehicles/{vehicle_id}/emergency

Request:
{
  "emergency_type": "breakdown",  # breakdown, malfunction, accident
  "severity": "critical",          # critical, warning, minor
  "description": "냉동기 완전 정지",
  "location": "서울시 강남구 테헤란로 123",
  "estimated_repair_time": 180     # 분
}

Response:
{
  "success": true,
  "vehicle_id": 123,
  "emergency_id": "EMG-2026-001",
  "affected_dispatches": [
    {
      "dispatch_id": "D2026-001",
      "pickup_time": "15:00",
      "delay_estimate": 30  # 분
    }
  ],
  "recommended_vehicles": [
    {
      "vehicle_id": 456,
      "plate_number": "34나5678",
      "distance_km": 5.2,
      "availability": true
    }
  ]
}
```

### 2. 대체 차량 배정

```http
POST /api/v1/dispatches/reassign

Request:
{
  "broken_vehicle_id": 123,
  "replacement_vehicle_id": 456,
  "dispatch_ids": ["D2026-001", "D2026-003"],
  "notify_customers": true
}

Response:
{
  "success": true,
  "reassigned_count": 2,
  "dispatches": [
    {
      "dispatch_id": "D2026-001",
      "original_vehicle": "12가3456",
      "new_vehicle": "34나5678",
      "customer_notified": true
    }
  ]
}
```

### 3. 긴급 알림 조회

```http
GET /api/v1/emergencies?status=active

Response:
{
  "total": 1,
  "items": [
    {
      "emergency_id": "EMG-2026-001",
      "vehicle_id": 123,
      "plate_number": "12가3456",
      "emergency_type": "breakdown",
      "severity": "critical",
      "reported_at": "2026-01-30T14:30:00",
      "affected_dispatches_count": 2,
      "status": "active"  # active, resolved, cancelled
    }
  ]
}
```

---

## 📱 모바일 앱 기능

### 운전자 앱

#### 긴급신고 버튼
```
[🚨 긴급신고]

📍 현재 위치 자동 기록
🚗 차량: 12가3456
👤 운전자: 홍길동

고장 유형:
○ 엔진 고장
● 냉동기 고장
○ 타이어 펑크
○ 사고
○ 기타

상황 설명:
[냉동기가 완전히 정지되어 온도가 상승하고 있습니다]

[📸 사진 첨부] [🎤 음성 메모]

예상 수리 시간:
○ 30분 이내
● 1-2시간
○ 당일 불가

[긴급신고 접수]
```

---

## 🎯 기대 효과

### 1. 신속한 대응
- 고장 발생 즉시 자동 감지
- 관리자 즉시 알림
- 평균 대응 시간: **5분 이내**

### 2. 서비스 연속성
- 대체 차량 자동 추천
- 배차 재조정 자동화
- 고객 서비스 중단 최소화

### 3. 고객 만족도
- 사전 통보로 신뢰 구축
- 지연 시간 최소화
- 투명한 상황 공유

### 4. 운영 효율화
- 수동 프로세스 자동화
- 의사결정 시간 단축
- 정비 이력 자동 기록

---

## 📊 KPI 지표

### 모니터링 항목
1. **평균 대응 시간**: 고장 신고 → 대체 차량 배정
2. **배차 성공률**: 긴급정비 발생 시 배차 완료율
3. **고객 만족도**: 긴급 상황 발생 시 고객 만족도
4. **정비 완료 시간**: 신고 → 정비 완료 → 복귀

### 목표
- 평균 대응 시간: **5분 이내**
- 배차 성공률: **95% 이상**
- 고객 만족도: **4.5/5.0 이상**
- 정비 완료 시간: **당일 80%, 익일 100%**

---

## 📝 향후 개선사항

1. **AI 고장 예측**
   - UVIS GPS 데이터 분석
   - 고장 사전 예측 및 예방 정비

2. **자동 배차 재조정**
   - AI 기반 최적 대체 차량 자동 배정
   - 복수 고장 동시 발생 시 전체 배차 재최적화

3. **정비 파트너 연동**
   - 정비소 자동 예약
   - 견적 자동 요청
   - 정비 진행 상황 실시간 공유

4. **보험사 자동 연동**
   - 사고 발생 시 보험 자동 청구
   - 사고 보고서 자동 생성

---

**작성일**: 2026-01-30  
**작성자**: GenSpark AI Developer  
**문서 버전**: 1.0
