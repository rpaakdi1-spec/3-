#!/bin/bash

# 🚀 배차 관리 필터링 기능 서버 배포 명령어
# Server Deployment Commands for Dispatch Filtering Feature
# 
# 이 파일의 명령어들을 서버(139.150.11.99)에서 순서대로 실행하세요.
# Execute these commands on the server (139.150.11.99) in order.

echo "=========================================="
echo "🚀 배차 관리 필터링 기능 서버 배포"
echo "=========================================="
echo ""

# ============================================
# 1단계: 프론트엔드 디렉토리로 이동
# ============================================
echo "📂 1단계: 프론트엔드 디렉토리로 이동..."
cd /root/uvis/frontend
pwd

# ============================================
# 2단계: 현재 Git 상태 확인
# ============================================
echo "📋 2단계: 현재 Git 상태 확인..."
git status

# ============================================
# 3단계: 변경사항이 있으면 임시 저장
# ============================================
echo "💾 3단계: 로컬 변경사항 임시 저장 (있을 경우)..."
echo "실행할 명령어:"
echo "git stash push -m 'deploy_filter_$(date +%Y%m%d_%H%M%S)'"
echo ""
echo "⚠️ 변경사항이 없으면 'No local changes to save' 메시지가 나타납니다."
echo ""

# ============================================
# 4단계: 최신 코드 가져오기
# ============================================
echo "⬇️ 4단계: 최신 코드 가져오기..."
git fetch origin main

# ============================================
# 5단계: 현재 커밋과 원격 커밋 확인
# ============================================
echo "📌 5단계: 커밋 상태 확인..."
echo "로컬 커밋:"
git rev-parse HEAD
echo ""
echo "원격 커밋:"
git rev-parse origin/main
echo ""

# ============================================
# 6단계: 원격 main과 동기화
# ============================================
echo "🔄 6단계: 원격 main과 강제 동기화..."
echo "⚠️ 주의: 로컬 변경사항이 모두 삭제됩니다!"
echo ""
git reset --hard origin/main

# ============================================
# 7단계: 최신 커밋 확인
# ============================================
echo "✅ 7단계: 최신 커밋 확인..."
git log --oneline -1
echo ""
echo "예상 커밋: 3cfdfb6 feat(frontend): Add comprehensive filtering to dispatch management"
echo ""

# ============================================
# 8단계: 필터링 기능 코드 확인
# ============================================
echo "🔍 8단계: 필터링 기능 코드 확인..."
echo ""
echo "8-1. 검색 필터 확인..."
grep -n "searchText" src/pages/DispatchesPage.tsx | head -5
echo ""

echo "8-2. 상태 필터 확인..."
grep -n "filterStatus" src/pages/DispatchesPage.tsx | head -5
echo ""

echo "8-3. 차량 필터 확인..."
grep -n "filterVehicle" src/pages/DispatchesPage.tsx | head -5
echo ""

echo "8-4. 날짜 필터 확인..."
grep -n "filterDate" src/pages/DispatchesPage.tsx | head -5
echo ""

echo "8-5. 필터링된 배차 로직 확인..."
grep -A 3 "filteredDispatches = " src/pages/DispatchesPage.tsx
echo ""

# ============================================
# 9단계: 프론트엔드 빌드
# ============================================
echo "🔨 9단계: 프론트엔드 빌드..."
npm run build
echo ""

# ============================================
# 10단계: 빌드 결과 확인
# ============================================
echo "✅ 10단계: 빌드 결과 확인..."
ls -lh dist/index.html
ls -lh dist/assets/ | head -10
echo ""

# ============================================
# 11단계: 도커 컨테이너에 복사
# ============================================
echo "📦 11단계: 빌드 파일을 도커 컨테이너에 복사..."
docker cp dist/. uvis-frontend:/usr/share/nginx/html/
echo ""

# ============================================
# 12단계: Nginx 캐시 클리어
# ============================================
echo "🧹 12단계: Nginx 캐시 클리어..."
docker exec uvis-nginx rm -rf /var/cache/nginx/*
echo ""

# ============================================
# 13단계: 컨테이너 재시작
# ============================================
echo "🔄 13단계: 컨테이너 재시작..."
docker restart uvis-frontend
docker restart uvis-nginx
echo ""

# ============================================
# 14단계: 대기
# ============================================
echo "⏳ 14단계: 컨테이너 시작 대기 (10초)..."
sleep 10
echo ""

# ============================================
# 15단계: 컨테이너 상태 확인
# ============================================
echo "🔍 15단계: 컨테이너 상태 확인..."
docker ps | grep -E "uvis-frontend|uvis-nginx"
echo ""

# ============================================
# 16단계: 로그 확인
# ============================================
echo "📋 16단계: 최근 로그 확인..."
echo ""
echo "Frontend 로그:"
docker logs uvis-frontend --tail 20
echo ""
echo "Nginx 로그:"
docker logs uvis-nginx --tail 20
echo ""

# ============================================
# 17단계: 헬스체크
# ============================================
echo "🏥 17단계: 헬스체크..."
curl -I http://localhost:80/ | head -n 1
echo ""

# ============================================
# 배포 완료
# ============================================
echo ""
echo "=========================================="
echo "✅ 배차 관리 필터링 기능 배포 완료!"
echo "=========================================="
echo ""
echo "📋 배포된 기능:"
echo "  ✅ 검색 필터: 배차번호, 차량, 운전자 검색"
echo "  ✅ 상태 필터: 전체, 임시저장, 확정, 진행중, 완료, 취소"
echo "  ✅ 차량 필터: 차량별 필터링"
echo "  ✅ 날짜 필터: 날짜별 필터링"
echo "  ✅ 결과 카운트: 필터링된 결과 수 표시"
echo ""

# ============================================
# 브라우저 테스트 안내
# ============================================
echo "🌐 브라우저 테스트 방법:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "⚠️ 중요: 반드시 캐시를 완전히 삭제해야 합니다!"
echo ""
echo "방법 1 - 브라우저 캐시 완전 삭제 (권장):"
echo "  1. 모든 브라우저 탭 닫기"
echo "  2. Ctrl + Shift + Delete (Chrome/Edge)"
echo "  3. '전체 기간' 선택"
echo "  4. '쿠키 및 기타 사이트 데이터' 체크"
echo "  5. '캐시된 이미지 및 파일' 체크"
echo "  6. '데이터 삭제' 클릭"
echo "  7. http://139.150.11.99 접속"
echo "  8. Ctrl + Shift + R 로 강제 새로고침"
echo ""
echo "방법 2 - InPrivate/Incognito 모드:"
echo "  1. Ctrl + Shift + N (Chrome) 또는"
echo "     Ctrl + Shift + P (Edge)"
echo "  2. http://139.150.11.99 접속"
echo "  3. 로그인"
echo ""
echo "방법 3 - 개발자 도구 캐시 삭제:"
echo "  1. F12 (개발자 도구 열기)"
echo "  2. Application 탭"
echo "  3. Storage → Clear site data"
echo "  4. Network 탭"
echo "  5. 'Disable cache' 체크"
echo "  6. Ctrl + Shift + R 새로고침"
echo ""

# ============================================
# 기능 테스트 안내
# ============================================
echo "🧪 기능 테스트 방법:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "1. 배차 관리 페이지로 이동"
echo "   → 좌측 메뉴에서 '배차 관리' 클릭"
echo ""
echo "2. 필터 영역 확인"
echo "   → 상단에 4개의 필터가 표시되어야 함:"
echo "     - 검색창 (🔍 아이콘)"
echo "     - 상태 드롭다운"
echo "     - 차량 드롭다운"
echo "     - 날짜 선택기 (📅 아이콘)"
echo ""
echo "3. 검색 필터 테스트"
echo "   → 검색창에 'DISP' 입력"
echo "   → 배차번호에 DISP가 포함된 항목만 표시"
echo "   → 검색창에 차량번호 입력 (예: '전남87')"
echo "   → 해당 차량의 배차만 표시"
echo ""
echo "4. 상태 필터 테스트"
echo "   → 상태 드롭다운에서 '진행중' 선택"
echo "   → 진행 중인 배차만 표시"
echo "   → '전체' 선택 시 모든 배차 표시"
echo ""
echo "5. 차량 필터 테스트"
echo "   → 차량 드롭다운에서 특정 차량 선택"
echo "   → 해당 차량의 배차만 표시"
echo ""
echo "6. 날짜 필터 테스트"
echo "   → 날짜 선택기에서 오늘 날짜 선택"
echo "   → 오늘 날짜의 배차만 표시"
echo ""
echo "7. 복합 필터 테스트"
echo "   → 여러 필터를 조합해서 사용"
echo "   → 예: 상태='진행중' + 날짜='오늘' + 검색='V전남87'"
echo "   → 모든 조건을 만족하는 배차만 표시"
echo ""
echo "8. 결과 카운트 확인"
echo "   → 필터 아래에 '총 X건 중 Y건 표시' 메시지"
echo "   → 필터 변경 시 실시간으로 카운트 업데이트"
echo ""

# ============================================
# 예상 결과
# ============================================
echo "✅ 예상 결과:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "  ✓ 각 필터가 독립적으로 동작"
echo "  ✓ 여러 필터를 조합해서 사용 가능"
echo "  ✓ 필터링된 결과가 즉시 표시"
echo "  ✓ 결과 카운트가 실시간 업데이트"
echo "  ✓ 성능 저하 없이 부드럽게 동작"
echo "  ✓ 모바일에서도 정상 동작"
echo ""

# ============================================
# 문제 발생 시 디버깅
# ============================================
echo "🔧 문제 발생 시 디버깅:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "문제 1: 필터가 보이지 않음"
echo "  원인: 브라우저 캐시에 오래된 파일이 남아있음"
echo "  해결:"
echo "    1. 브라우저 캐시 완전 삭제"
echo "    2. InPrivate 모드로 테스트"
echo "    3. F12 → Console에서 오류 확인"
echo ""
echo "문제 2: 필터가 동작하지 않음"
echo "  원인: JavaScript 오류"
echo "  해결:"
echo "    1. F12 → Console 탭에서 오류 확인"
echo "    2. 오류 메시지를 개발팀에 전달"
echo "    3. 서버 로그 확인:"
echo "       docker logs uvis-frontend --tail 50"
echo ""
echo "문제 3: 검색 시 아무것도 표시되지 않음"
echo "  원인: 검색어가 정확하지 않거나 데이터 없음"
echo "  해결:"
echo "    1. 검색창 비우고 다시 시도"
echo "    2. 전체 배차 목록 확인"
echo "    3. F12 → Network 탭에서 API 응답 확인"
echo ""
echo "문제 4: 차량 드롭다운이 비어있음"
echo "  원인: 배차 데이터에 vehicle_plate 없음"
echo "  해결:"
echo "    1. API 응답 확인:"
echo "       curl http://localhost:8000/api/v1/dispatches | jq '.[] | {id, vehicle_plate}'"
echo "    2. vehicle_plate 필드 없으면 백엔드 수정 필요"
echo ""

# ============================================
# 롤백 방법
# ============================================
echo "↩️ 롤백 방법 (문제 발생 시):"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "이전 버전으로 되돌리기:"
echo "  cd /root/uvis/frontend"
echo "  git log --oneline -5"
echo "  git reset --hard <이전_커밋_해시>"
echo "  npm run build"
echo "  docker cp dist/. uvis-frontend:/usr/share/nginx/html/"
echo "  docker restart uvis-frontend uvis-nginx"
echo ""

# ============================================
# 추가 정보
# ============================================
echo "📚 추가 정보:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "  📄 상세 문서: DISPATCH_FILTER_FEATURE.md"
echo "  🔗 GitHub: https://github.com/rpaakdi1-spec/3-/commits/main"
echo "  📝 커밋: 3cfdfb6 (필터 기능), ceecaaa (배포 스크립트)"
echo ""
echo "  📧 문의: 개발팀"
echo "  🐛 버그 리포트: GitHub Issues"
echo ""

# ============================================
# 완료 메시지
# ============================================
echo "=========================================="
echo "✅ 서버 배포 스크립트 실행 완료!"
echo "=========================================="
echo ""
echo "이제 브라우저에서 http://139.150.11.99 로 접속하여"
echo "필터링 기능을 테스트해주세요!"
echo ""
